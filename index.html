<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gest√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#16a34a;--secondary:#f97316}
        *{font-family:'Inter',sans-serif}
        .bg-primary{background-color:var(--primary)}.text-primary{color:var(--primary)}
        .chip{padding:3px 10px;border-radius:99px;font-size:11px;font-weight:500;display:inline-block}
        .chip-recebida{background:#dbeafe;color:#1e40af}.chip-em_analise{background:#fef3c7;color:#92400e}
        .chip-diligencia{background:#fce7f3;color:#9d174d}.chip-priorizada,.chip-deferida{background:#d1fae5;color:#065f46}
        .chip-encerrada,.chip-arquivado{background:#e5e7eb;color:#374151}.chip-indeferida,.chip-travado{background:#fee2e2;color:#991b1b}
        .chip-baixa{background:#e0e7ff;color:#3730a3}.chip-media{background:#fef3c7;color:#92400e}
        .chip-alta{background:#fee2e2;color:#991b1b}.chip-critica{background:#7f1d1d;color:#fff}
        .chip-iniciado,.chip-articulacao{background:#dbeafe;color:#1e40af}.chip-em_andamento,.chip-execucao{background:#fef3c7;color:#92400e}
        .chip-aguardando_terceiros{background:#fce7f3;color:#9d174d}.chip-concluido,.chip-monitoramento{background:#d1fae5;color:#065f46}
        .chip-concepcao,.chip-planejamento{background:#f3e8ff;color:#6b21a8}
        .chip-administrativo{background:#e0e7ff;color:#3730a3}.chip-legislativo{background:#d1fae5;color:#065f46}
        .chip-politico_institucional{background:#fce7f3;color:#9d174d}.chip-judicial,.chip-orcamentario{background:#fef3c7;color:#92400e}
        .loader{border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .sidebar{width:240px;min-height:100vh}
        .sidebar-item{padding:12px 16px;display:flex;align-items:center;gap:10px;border-radius:8px;margin:3px 10px;cursor:pointer;color:rgba(255,255,255,.8)}
        .sidebar-item:hover{background:rgba(255,255,255,.1)}.sidebar-item.active{background:rgba(255,255,255,.2);color:#fff;font-weight:600}
        .btn{padding:8px 16px;border-radius:8px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-size:14px}
        .btn-primary{background-color:var(--primary);color:#fff;border:none}.btn-primary:hover{filter:brightness(1.1)}
        .btn-secondary{background:#fff;border:1px solid #e5e7eb;color:#374151}.btn-secondary:hover{background:#f9fafb}
        .btn-danger{background:#fee2e2;color:#991b1b;border:none}
        .input{width:100%;padding:9px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
        .input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(22,163,74,.15)}
        .input-label{display:block;font-size:13px;font-weight:500;color:#374151;margin-bottom:4px}
        .modal-bg{background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
        .stat-card{background:linear-gradient(135deg,var(--primary),#22c55e);border-radius:12px;padding:16px;color:#fff}
        .stat-card.orange{background:linear-gradient(135deg,#f97316,#fb923c)}
        .stat-card.purple{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}
        .stat-card.blue{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
        @media(max-width:768px){.sidebar{position:fixed;left:-100%;top:0;z-index:50;transition:left .3s}.sidebar.open{left:0}}
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- LOGIN -->
<div id="login-screen" class="min-h-screen flex items-center justify-center bg-primary p-4">
    <div class="card p-8 w-full max-w-md">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-primary rounded-xl flex items-center justify-center mx-auto mb-3">
                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            </div>
            <h1 class="text-xl font-bold text-gray-900">Painel de Gest√£o</h1>
            <p class="text-gray-500 text-sm">Gabinete Parlamentar</p>
        </div>
        <form id="login-form" class="space-y-4">
            <div><label class="input-label">Email</label><input type="email" id="login-email" class="input" required placeholder="seu@email.com"></div>
            <div><label class="input-label">Senha</label><input type="password" id="login-password" class="input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div id="login-error" class="text-red-600 text-sm hidden p-3 bg-red-50 rounded-lg"></div>
            <button type="submit" class="btn btn-primary w-full justify-center">Entrar <span id="login-loader" class="loader hidden"></span></button>
            <p class="text-xs text-gray-500 text-center">Primeiro acesso? Use email novo para criar conta.</p>
        </form>
    </div>
</div>

<!-- MAIN -->
<div id="main-screen" class="hidden"><div class="flex">

<!-- Sidebar -->
<aside id="sidebar" class="sidebar bg-primary text-white flex-col hidden md:flex">
    <div class="p-5 border-b border-white/20"><h1 class="font-bold">Painel de Gest√£o</h1><p class="text-white/70 text-sm">Gabinete Parlamentar</p></div>
    <nav class="py-3 flex-1">
        <div onclick="showTab('dashboard')" class="sidebar-item active" data-tab="dashboard">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
            <span>Dashboard</span>
        </div>
        <div onclick="showTab('propostas')" class="sidebar-item" data-tab="propostas">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span>Propostas OSC</span>
        </div>
        <div onclick="showTab('processos')" class="sidebar-item" data-tab="processos">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            <span>Processos</span>
        </div>
        <div onclick="showTab('projetos')" class="sidebar-item" data-tab="projetos">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            <span>Projetos</span>
        </div>
        <div onclick="showTab('importar')" class="sidebar-item" data-tab="importar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
            <span>Importar</span>
        </div>
        <div onclick="showTab('config')" class="sidebar-item" data-tab="config">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Config</span>
        </div>
    </nav>
    <div class="p-4 border-t border-white/20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <span id="user-email" class="text-sm truncate flex-1"></span>
            <button onclick="logout()" class="p-1 hover:bg-white/10 rounded" title="Sair">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
            </button>
        </div>
    </div>
</aside>
<div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleSidebar()"></div>

<!-- Content -->
<main class="flex-1 min-h-screen">
<header class="md:hidden bg-white shadow-sm p-3 flex items-center gap-3 sticky top-0 z-30">
    <button onclick="toggleSidebar()" class="p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
    <h1 class="font-bold">Painel de Gest√£o</h1>
</header>

<div class="p-4 md:p-6">

<!-- DASHBOARD -->
<div id="tab-dashboard" class="tab-content">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div><h2 class="text-2xl font-bold text-gray-900">Dashboard</h2><p class="text-gray-500">Vis√£o geral</p></div>
        <button onclick="exportDashboardPDF()" class="btn btn-secondary">üìÑ Exportar PDF</button>
    </div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="stat-card"><div class="text-3xl font-bold" id="stat-propostas">0</div><div class="text-white/80 text-sm">Propostas</div><div class="text-xs text-white/60" id="stat-prop-sub">0 pendentes</div></div>
        <div class="stat-card orange"><div class="text-3xl font-bold" id="stat-processos">0</div><div class="text-white/80 text-sm">Processos</div><div class="text-xs text-white/60" id="stat-proc-sub">0 em andamento</div></div>
        <div class="stat-card purple"><div class="text-3xl font-bold" id="stat-projetos">0</div><div class="text-white/80 text-sm">Projetos</div><div class="text-xs text-white/60" id="stat-proj-sub">0 em execu√ß√£o</div></div>
        <div class="stat-card blue"><div class="text-3xl font-bold" id="stat-alertas">0</div><div class="text-white/80 text-sm">Alertas</div><div class="text-xs text-white/60">sem atualiza√ß√£o</div></div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card p-5"><h3 class="font-semibold mb-4">Propostas por Status</h3><div style="height:200px"><canvas id="chart-propostas"></canvas></div></div>
        <div class="card p-5"><h3 class="font-semibold mb-4">Processos por Tipo</h3><div style="height:200px"><canvas id="chart-processos"></canvas></div></div>
        <div class="card p-5"><h3 class="font-semibold mb-4">Projetos por Fase</h3><div style="height:200px"><canvas id="chart-projetos"></canvas></div></div>
        <div class="card p-5"><h3 class="font-semibold mb-4">Prioridades</h3><div style="height:200px"><canvas id="chart-prioridades"></canvas></div></div>
    </div>
    <div class="card p-5"><h3 class="font-semibold mb-4">‚ö†Ô∏è Alertas - Itens sem atualiza√ß√£o h√° 7+ dias</h3><div id="alerts-list"></div></div>
    
    <!-- PAINEL ESTRAT√âGICO -->
    <div class="card p-5 mt-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">‚≠ê Painel Estrat√©gico - Itens Priorit√°rios</h3>
            <button onclick="exportResumoExecutivo()" class="btn btn-secondary text-sm">üìã Resumo Executivo</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-green-50 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-green-700" id="strat-em-dia">0</div>
                <div class="text-xs text-green-600">Em dia</div>
            </div>
            <div class="bg-amber-50 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-amber-700" id="strat-atencao">0</div>
                <div class="text-xs text-amber-600">Precisam aten√ß√£o</div>
            </div>
            <div class="bg-red-50 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-red-700" id="strat-criticos">0</div>
                <div class="text-xs text-red-600">Cr√≠ticos/Atrasados</div>
            </div>
        </div>
        <div id="strategic-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
    </div>
</div>

<!-- PROPOSTAS -->
<div id="tab-propostas" class="tab-content hidden">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div><h2 class="text-2xl font-bold">Propostas de OSC</h2><p class="text-gray-500">Gest√£o de propostas</p></div>
        <div class="flex flex-wrap gap-2">
            <button onclick="exportCSV('propostas')" class="btn btn-secondary text-sm">CSV</button>
            <button onclick="exportPDF('propostas')" class="btn btn-secondary text-sm">PDF</button>
            <button onclick="openPropostaModal()" class="btn btn-primary">+ Nova Proposta</button>
        </div>
    </div>
    <div class="card overflow-hidden">
        <div class="p-3 border-b grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="text" id="filter-propostas" placeholder="Buscar..." class="input" oninput="renderPropostas()">
            <select id="filter-prop-status" class="input" onchange="renderPropostas()"><option value="">Status</option><option value="recebida">Recebida</option><option value="em_analise">Em an√°lise</option><option value="diligencia">Dilig√™ncia</option><option value="priorizada">Priorizada</option><option value="deferida">Deferida</option><option value="indeferida">Indeferida</option><option value="encerrada">Encerrada</option></select>
            <select id="filter-prop-priority" class="input" onchange="renderPropostas()"><option value="">Prioridade</option><option value="baixa">Baixa</option><option value="media">M√©dia</option><option value="alta">Alta</option><option value="critica">Cr√≠tica</option></select>
            <select id="filter-prop-strat" class="input" onchange="renderPropostas()"><option value="">Todos</option><option value="1">Estrat√©gicos</option></select>
        </div>
        <div id="propostas-list" class="divide-y max-h-[500px] overflow-y-auto"></div>
    </div>
</div>

<!-- PROCESSOS -->
<div id="tab-processos" class="tab-content hidden">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div><h2 class="text-2xl font-bold">Processos Estrat√©gicos</h2><p class="text-gray-500">Acompanhamento</p></div>
        <div class="flex flex-wrap gap-2">
            <button onclick="exportCSV('processos')" class="btn btn-secondary text-sm">CSV</button>
            <button onclick="exportPDF('processos')" class="btn btn-secondary text-sm">PDF</button>
            <button onclick="openProcessoModal()" class="btn btn-primary">+ Novo Processo</button>
        </div>
    </div>
    <div class="card overflow-hidden">
        <div class="p-3 border-b grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="text" id="filter-processos" placeholder="Buscar..." class="input" oninput="renderProcessos()">
            <select id="filter-proc-type" class="input" onchange="renderProcessos()"><option value="">Tipo</option><option value="administrativo">Administrativo</option><option value="legislativo">Legislativo</option><option value="politico_institucional">Pol√≠tico</option><option value="judicial">Judicial</option><option value="orcamentario">Or√ßament√°rio</option></select>
            <select id="filter-proc-status" class="input" onchange="renderProcessos()"><option value="">Status</option><option value="iniciado">Iniciado</option><option value="em_andamento">Em andamento</option><option value="aguardando_terceiros">Aguardando</option><option value="travado">Travado</option><option value="concluido">Conclu√≠do</option><option value="arquivado">Arquivado</option></select>
            <select id="filter-proc-priority" class="input" onchange="renderProcessos()"><option value="">Prioridade</option><option value="baixa">Baixa</option><option value="media">M√©dia</option><option value="alta">Alta</option><option value="critica">Cr√≠tica</option></select>
        </div>
        <div id="processos-list" class="divide-y max-h-[500px] overflow-y-auto"></div>
    </div>
</div>

<!-- PROJETOS -->
<div id="tab-projetos" class="tab-content hidden">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div><h2 class="text-2xl font-bold">Projetos Estrat√©gicos</h2><p class="text-gray-500">Gest√£o de projetos</p></div>
        <div class="flex flex-wrap gap-2">
            <button onclick="exportCSV('projetos')" class="btn btn-secondary text-sm">CSV</button>
            <button onclick="exportPDF('projetos')" class="btn btn-secondary text-sm">PDF</button>
            <button onclick="openProjetoModal()" class="btn btn-primary">+ Novo Projeto</button>
        </div>
    </div>
    <div class="card overflow-hidden">
        <div class="p-3 border-b grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="text" id="filter-projetos" placeholder="Buscar..." class="input" oninput="renderProjetos()">
            <select id="filter-proj-status" class="input" onchange="renderProjetos()"><option value="">Fase</option><option value="concepcao">Concep√ß√£o</option><option value="planejamento">Planejamento</option><option value="articulacao">Articula√ß√£o</option><option value="execucao">Execu√ß√£o</option><option value="monitoramento">Monitoramento</option><option value="concluido">Conclu√≠do</option></select>
            <select id="filter-proj-priority" class="input" onchange="renderProjetos()"><option value="">Prioridade</option><option value="baixa">Baixa</option><option value="media">M√©dia</option><option value="alta">Alta</option><option value="critica">Cr√≠tica</option></select>
            <select id="filter-proj-axis" class="input" onchange="renderProjetos()"><option value="">Eixo</option></select>
        </div>
        <div id="projetos-list" class="divide-y max-h-[500px] overflow-y-auto"></div>
    </div>
</div>

<!-- IMPORTAR -->
<div id="tab-importar" class="tab-content hidden">
    <div class="mb-6"><h2 class="text-2xl font-bold">Importar Planilha</h2><p class="text-gray-500">Excel (.xlsx) ou copiar do Google Sheets</p></div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
            <h3 class="font-semibold mb-4">üìÅ Arquivo Excel</h3>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-4">
                <input type="file" id="import-file" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event)">
                <p class="text-gray-600 mb-2">Arraste ou selecione arquivo</p>
                <button onclick="document.getElementById('import-file').click()" class="btn btn-primary">Selecionar</button>
            </div>
            <div id="import-preview" class="hidden"><h4 class="font-medium mb-2">Pr√©via:</h4><div id="preview-content" class="max-h-40 overflow-auto border rounded text-sm mb-3"></div><div class="flex gap-2"><button onclick="confirmImport()" class="btn btn-primary flex-1">Importar</button><button onclick="cancelImport()" class="btn btn-secondary">Cancelar</button></div></div>
            <div id="import-status" class="mt-3 text-sm"></div>
        </div>
        <div class="card p-6">
            <h3 class="font-semibold mb-4">üìã Colar do Google Sheets</h3>
            <textarea id="import-paste" rows="6" class="input font-mono text-sm mb-3" placeholder="Cole aqui (Ctrl+V)..."></textarea>
            <button onclick="importFromPaste()" class="btn btn-primary w-full">Importar Colado</button>
        </div>
    </div>
</div>

<!-- CONFIG -->
<div id="tab-config" class="tab-content hidden">
    <div class="mb-6"><h2 class="text-2xl font-bold">Configura√ß√µes</h2></div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
            <h3 class="font-semibold mb-4">üé® Cores</h3>
            <div class="space-y-3">
                <div><label class="input-label">Cor Principal</label><div class="flex gap-2"><input type="color" id="cfg-color1" class="w-12 h-9 rounded border cursor-pointer"><input type="text" id="cfg-color1-t" class="input flex-1"></div></div>
                <div><label class="input-label">Cor Secund√°ria</label><div class="flex gap-2"><input type="color" id="cfg-color2" class="w-12 h-9 rounded border cursor-pointer"><input type="text" id="cfg-color2-t" class="input flex-1"></div></div>
            </div>
        </div>
        <div class="card p-6">
            <h3 class="font-semibold mb-4">üìù Eixos Estrat√©gicos</h3>
            <textarea id="cfg-axes" rows="5" class="input text-sm mb-3" placeholder="Um por linha"></textarea>
        </div>
        <div class="card p-6 lg:col-span-2">
            <div class="flex flex-wrap gap-3">
                <button onclick="saveConfig()" class="btn btn-primary">Salvar Config</button>
                <button onclick="resetConfig()" class="btn btn-secondary">Restaurar Padr√£o</button>
                <button onclick="exportAllData()" class="btn btn-secondary">üì• Exportar Backup</button>
                <button onclick="document.getElementById('backup-file').click()" class="btn btn-secondary">üì§ Importar Backup</button>
                <input type="file" id="backup-file" class="hidden" accept=".json" onchange="importBackup(event)">
            </div>
        </div>
    </div>
</div>

</div>
</main>
</div></div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-bg absolute inset-0" onclick="closeModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
        <div class="flex items-center justify-between p-4 border-b">
            <h3 id="modal-title" class="font-semibold text-lg"></h3>
            <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button>
        </div>
        <div id="modal-body" class="p-4 overflow-y-auto flex-1"></div>
    </div>
</div>

<script>
// ========== GLOBAL VARIABLES ==========
var db, propostas = [], processos = [], projetos = [], charts = {}, importData = [];

var labels = {
    recebida:'Recebida',em_analise:'Em an√°lise',diligencia:'Dilig√™ncia',priorizada:'Priorizada',
    encerrada:'Encerrada',deferida:'Deferida',indeferida:'Indeferida',
    baixa:'Baixa',media:'M√©dia',alta:'Alta',critica:'Cr√≠tica',
    iniciado:'Iniciado',em_andamento:'Em andamento',aguardando_terceiros:'Aguardando',
    travado:'Travado',concluido:'Conclu√≠do',arquivado:'Arquivado',
    concepcao:'Concep√ß√£o',planejamento:'Planejamento',articulacao:'Articula√ß√£o',
    execucao:'Execu√ß√£o',monitoramento:'Monitoramento',
    administrativo:'Admin',legislativo:'Legisl',politico_institucional:'Pol√≠tico',
    judicial:'Judicial',orcamentario:'Or√ßam'
};

// ========== HELPERS ==========
function chip(v) {
    return '<span class="chip chip-' + v + '">' + (labels[v] || v || '-') + '</span>';
}

function fmtDate(d) {
    if (!d) return '-';
    try { return new Date(d).toLocaleDateString('pt-BR'); } catch(e) { return d; }
}

function fmtCurrency(v) {
    if (!v) return '-';
    var n = parseFloat(String(v).replace(/[^\d,.-]/g, '').replace(',', '.'));
    return isNaN(n) ? v : n.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
}

function decode(t) {
    if (!t) return '';
    return String(t).replace(/√É¬£/g,'√£').replace(/√É¬°/g,'√°').replace(/√É¬©/g,'√©').replace(/√É¬≠/g,'√≠')
        .replace(/√É¬≥/g,'√≥').replace(/√É¬∫/g,'√∫').replace(/√É¬ß/g,'√ß').replace(/√É¬™/g,'√™')
        .replace(/√É¬¥/g,'√¥').replace(/√É¬¢/g,'√¢').replace(/√É¬µ/g,'√µ');
}

// ========== NAVIGATION ==========
function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.add('hidden'); });
    document.querySelectorAll('.sidebar-item').forEach(function(i) { i.classList.remove('active'); });
    var tab = document.getElementById('tab-' + id);
    if (tab) tab.classList.remove('hidden');
    var item = document.querySelector('[data-tab="' + id + '"]');
    if (item) item.classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').classList.add('hidden');
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebar').classList.toggle('flex');
    document.getElementById('sidebar-overlay').classList.toggle('hidden');
}

function openModal() { document.getElementById('modal').classList.remove('hidden'); }
function closeModal() { document.getElementById('modal').classList.add('hidden'); }

function logout() {
    if (typeof firebase !== 'undefined') {
        firebase.auth().signOut();
    }
}

// ========== RENDER FUNCTIONS ==========
function renderPropostas() {
    var s = (document.getElementById('filter-propostas').value || '').toLowerCase();
    var st = document.getElementById('filter-prop-status').value;
    var pr = document.getElementById('filter-prop-priority').value;
    var str = document.getElementById('filter-prop-strat').value;
    
    var items = propostas.filter(function(p) {
        if (s && (p.project_name || '').toLowerCase().indexOf(s) === -1 && (p.osc_name || '').toLowerCase().indexOf(s) === -1) return false;
        if (st && p.status !== st) return false;
        if (pr && p.priority !== pr) return false;
        if (str === '1' && !p.is_strategic) return false;
        return true;
    });
    
    var list = document.getElementById('propostas-list');
    if (!items.length) {
        list.innerHTML = '<div class="p-6 text-center text-gray-500">Nenhuma proposta</div>';
        return;
    }
    
    list.innerHTML = items.map(function(p) {
        return '<div class="p-3 hover:bg-gray-50 cursor-pointer" onclick="openPropostaModal(\'' + p.id + '\')">' +
            '<div class="flex justify-between gap-3">' +
            '<div class="min-w-0 flex-1">' +
            '<div class="flex flex-wrap gap-1 mb-1">' + chip(p.status) + ' ' + chip(p.priority) + (p.is_strategic ? ' <span class="chip bg-yellow-100 text-yellow-800">‚≠ê</span>' : '') + '</div>' +
            '<div class="font-medium text-gray-900 truncate">' + (decode(p.project_name) || 'Sem nome') + '</div>' +
            '<div class="text-sm text-gray-500 truncate">' + (decode(p.osc_name) || '-') + '</div>' +
            '</div>' +
            '<div class="text-right text-sm">' +
            '<div class="font-medium">' + fmtCurrency(p.requested_value) + '</div>' +
            '<div class="text-gray-500">' + fmtDate(p.submitted_at) + '</div>' +
            '</div></div></div>';
    }).join('');
}

function renderProcessos() {
    var s = (document.getElementById('filter-processos').value || '').toLowerCase();
    var tp = document.getElementById('filter-proc-type').value;
    var st = document.getElementById('filter-proc-status').value;
    var pr = document.getElementById('filter-proc-priority').value;
    
    var items = processos.filter(function(p) {
        if (s && (p.title || '').toLowerCase().indexOf(s) === -1 && (p.sei || '').toLowerCase().indexOf(s) === -1) return false;
        if (tp && p.type !== tp) return false;
        if (st && p.status !== st) return false;
        if (pr && p.priority !== pr) return false;
        return true;
    });
    
    var list = document.getElementById('processos-list');
    if (!items.length) {
        list.innerHTML = '<div class="p-6 text-center text-gray-500">Nenhum processo</div>';
        return;
    }
    
    list.innerHTML = items.map(function(p) {
        return '<div class="p-3 hover:bg-gray-50 cursor-pointer" onclick="openProcessoModal(\'' + p.id + '\')">' +
            '<div class="flex justify-between gap-3">' +
            '<div class="min-w-0 flex-1">' +
            '<div class="flex flex-wrap gap-1 mb-1">' + chip(p.type) + ' ' + chip(p.status) + ' ' + chip(p.priority) + (p.is_strategic ? ' <span class="chip bg-yellow-100 text-yellow-800">‚≠ê</span>' : '') + '</div>' +
            '<div class="font-medium text-gray-900">' + (decode(p.title) || 'Sem t√≠tulo') + '</div>' +
            '<div class="text-sm text-gray-500">' + (p.sei ? 'SEI: ' + p.sei : '') + (p.responsible ? ' ¬∑ ' + decode(p.responsible) : '') + '</div>' +
            '</div>' +
            '<div class="text-right text-sm text-gray-500">' + fmtDate(p.deadline) + '<div class="text-xs">Prazo</div></div>' +
            '</div></div>';
    }).join('');
}

function renderProjetos() {
    var s = (document.getElementById('filter-projetos').value || '').toLowerCase();
    var st = document.getElementById('filter-proj-status').value;
    var pr = document.getElementById('filter-proj-priority').value;
    var ax = document.getElementById('filter-proj-axis').value;
    
    var items = projetos.filter(function(p) {
        if (s && (p.name || '').toLowerCase().indexOf(s) === -1) return false;
        if (st && p.status !== st) return false;
        if (pr && p.priority !== pr) return false;
        if (ax && p.axis !== ax) return false;
        return true;
    });
    
    var list = document.getElementById('projetos-list');
    if (!items.length) {
        list.innerHTML = '<div class="p-6 text-center text-gray-500">Nenhum projeto</div>';
        return;
    }
    
    list.innerHTML = items.map(function(p) {
        return '<div class="p-3 hover:bg-gray-50 cursor-pointer" onclick="openProjetoModal(\'' + p.id + '\')">' +
            '<div class="flex justify-between gap-3">' +
            '<div class="min-w-0 flex-1">' +
            '<div class="flex flex-wrap gap-1 mb-1">' + chip(p.status) + ' ' + chip(p.priority) + (p.is_strategic ? ' <span class="chip bg-yellow-100 text-yellow-800">‚≠ê</span>' : '') + '</div>' +
            '<div class="font-medium text-gray-900">' + (decode(p.name) || 'Sem nome') + '</div>' +
            '<div class="text-sm text-gray-500">' + (decode(p.axis) || '-') + (p.coordinator ? ' ¬∑ ' + decode(p.coordinator) : '') + '</div>' +
            '</div>' +
            '<div class="text-right">' +
            '<div class="text-sm font-medium">' + (p.progress || 0) + '%</div>' +
            '<div class="w-16 h-2 bg-gray-200 rounded-full mt-1"><div class="h-2 rounded-full bg-primary" style="width:' + (p.progress || 0) + '%"></div></div>' +
            '</div></div></div>';
    }).join('');
}

function updateAxisFilter() {
    var axes = [];
    projetos.forEach(function(p) {
        if (p.axis && axes.indexOf(p.axis) === -1) axes.push(p.axis);
    });
    var sel = document.getElementById('filter-proj-axis');
    if (!sel) return;
    sel.innerHTML = '<option value="">Eixo</option>' + axes.map(function(a) {
        return '<option value="' + a + '">' + a + '</option>';
    }).join('');
}

// ========== DASHBOARD ==========
function updateDashboard() {
    document.getElementById('stat-propostas').textContent = propostas.length;
    var pendentes = propostas.filter(function(p) { return ['encerrada','deferida','indeferida'].indexOf(p.status) === -1; }).length;
    document.getElementById('stat-prop-sub').textContent = pendentes + ' pendentes';
    
    document.getElementById('stat-processos').textContent = processos.length;
    var andamento = processos.filter(function(p) { return p.status === 'em_andamento'; }).length;
    document.getElementById('stat-proc-sub').textContent = andamento + ' em andamento';
    
    document.getElementById('stat-projetos').textContent = projetos.length;
    var execucao = projetos.filter(function(p) { return p.status === 'execucao'; }).length;
    document.getElementById('stat-proj-sub').textContent = execucao + ' em execu√ß√£o';
    
    // Alerts
    var cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 7);
    var alerts = [];
    
    propostas.forEach(function(p) {
        if (['encerrada','deferida','indeferida'].indexOf(p.status) === -1 && new Date(p.updated_at) < cutoff) {
            alerts.push({type: 'Proposta', title: p.project_name, status: p.status, fn: 'openPropostaModal', id: p.id});
        }
    });
    processos.forEach(function(p) {
        if (['concluido','arquivado'].indexOf(p.status) === -1 && new Date(p.updated_at) < cutoff) {
            alerts.push({type: 'Processo', title: p.title, status: p.status, fn: 'openProcessoModal', id: p.id});
        }
    });
    projetos.forEach(function(p) {
        if (p.status !== 'concluido' && new Date(p.updated_at) < cutoff) {
            alerts.push({type: 'Projeto', title: p.name, status: p.status, fn: 'openProjetoModal', id: p.id});
        }
    });
    
    document.getElementById('stat-alertas').textContent = alerts.length;
    var al = document.getElementById('alerts-list');
    
    if (alerts.length) {
        al.innerHTML = alerts.slice(0, 10).map(function(a) {
            return '<div class="flex items-center justify-between p-3 bg-amber-50 rounded-lg cursor-pointer hover:bg-amber-100 mb-2" onclick="' + a.fn + '(\'' + a.id + '\')">' +
                '<div><span class="text-xs font-medium text-amber-700">' + a.type + '</span>' +
                '<div class="text-sm">' + (decode(a.title) || 'Sem t√≠tulo') + '</div></div>' +
                chip(a.status) + '</div>';
        }).join('');
    } else {
        al.innerHTML = '<div class="text-center py-4 text-gray-500">üéâ Nenhum alerta!</div>';
    }
    
    updateCharts();
    updateStrategicPanel();
}

function updateStrategicPanel() {
    // Coletar todos os itens estrat√©gicos (marcados como is_strategic ou prioridade alta/cr√≠tica)
    var strategic = [];
    var now = new Date();
    
    propostas.forEach(function(p) {
        if ((p.is_strategic || p.priority === 'alta' || p.priority === 'critica') && 
            ['encerrada','deferida','indeferida'].indexOf(p.status) === -1) {
            var days = Math.floor((now - new Date(p.updated_at)) / 86400000);
            strategic.push({
                type: 'Proposta', title: p.project_name, status: p.status, priority: p.priority,
                days: days, fn: 'openPropostaModal', id: p.id, is_strategic: p.is_strategic
            });
        }
    });
    processos.forEach(function(p) {
        if ((p.is_strategic || p.priority === 'alta' || p.priority === 'critica') && 
            ['concluido','arquivado'].indexOf(p.status) === -1) {
            var days = Math.floor((now - new Date(p.updated_at)) / 86400000);
            strategic.push({
                type: 'Processo', title: p.title, status: p.status, priority: p.priority,
                days: days, fn: 'openProcessoModal', id: p.id, is_strategic: p.is_strategic
            });
        }
    });
    projetos.forEach(function(p) {
        if ((p.is_strategic || p.priority === 'alta' || p.priority === 'critica') && 
            p.status !== 'concluido') {
            var days = Math.floor((now - new Date(p.updated_at)) / 86400000);
            strategic.push({
                type: 'Projeto', title: p.name, status: p.status, priority: p.priority,
                days: days, progress: p.progress || 0, fn: 'openProjetoModal', id: p.id, is_strategic: p.is_strategic
            });
        }
    });
    
    // Classificar por situa√ß√£o
    var emDia = strategic.filter(function(s) { return s.days <= 3; }).length;
    var atencao = strategic.filter(function(s) { return s.days > 3 && s.days <= 7; }).length;
    var criticos = strategic.filter(function(s) { return s.days > 7 || s.priority === 'critica'; }).length;
    
    document.getElementById('strat-em-dia').textContent = emDia;
    document.getElementById('strat-atencao').textContent = atencao;
    document.getElementById('strat-criticos').textContent = criticos;
    
    // Ordenar: cr√≠ticos primeiro, depois por dias sem atualiza√ß√£o
    var prioOrder = {critica: 0, alta: 1, media: 2, baixa: 3};
    strategic.sort(function(a, b) {
        return (prioOrder[a.priority] || 2) - (prioOrder[b.priority] || 2) || b.days - a.days;
    });
    
    var list = document.getElementById('strategic-list');
    if (strategic.length) {
        list.innerHTML = strategic.map(function(s) {
            var bgColor = s.days > 7 ? 'bg-red-50' : (s.days > 3 ? 'bg-amber-50' : 'bg-green-50');
            var statusColor = s.days > 7 ? 'text-red-700' : (s.days > 3 ? 'text-amber-700' : 'text-green-700');
            return '<div class="flex items-center justify-between p-3 ' + bgColor + ' rounded-lg cursor-pointer hover:opacity-80" onclick="' + s.fn + '(\'' + s.id + '\')">' +
                '<div class="flex-1">' +
                '<div class="flex items-center gap-2 mb-1">' +
                '<span class="text-xs font-medium text-gray-600">' + s.type + '</span>' +
                (s.is_strategic ? '<span class="text-yellow-500">‚≠ê</span>' : '') +
                chip(s.priority) + ' ' + chip(s.status) +
                '</div>' +
                '<div class="text-sm font-medium">' + (decode(s.title) || 'Sem t√≠tulo') + '</div>' +
                '</div>' +
                '<div class="text-right">' +
                '<div class="text-xs ' + statusColor + ' font-medium">' + (s.days === 0 ? 'Hoje' : s.days + 'd') + '</div>' +
                (s.progress !== undefined ? '<div class="text-xs text-gray-500">' + s.progress + '%</div>' : '') +
                '</div></div>';
        }).join('');
    } else {
        list.innerHTML = '<div class="text-center py-6 text-gray-500">Nenhum item estrat√©gico ativo.<br><span class="text-xs">Marque itens como ‚≠ê ou defina prioridade Alta/Cr√≠tica</span></div>';
    }
}

function exportResumoExecutivo() {
    var now = new Date();
    var dataHora = now.toLocaleString('pt-BR');
    
    // Coletar estrat√©gicos
    var strategic = [];
    propostas.forEach(function(p) {
        if ((p.is_strategic || p.priority === 'alta' || p.priority === 'critica') && 
            ['encerrada','deferida','indeferida'].indexOf(p.status) === -1) {
            var days = Math.floor((now - new Date(p.updated_at)) / 86400000);
            strategic.push({type: 'Proposta', title: p.project_name, status: labels[p.status] || p.status, priority: labels[p.priority] || p.priority, days: days});
        }
    });
    processos.forEach(function(p) {
        if ((p.is_strategic || p.priority === 'alta' || p.priority === 'critica') && 
            ['concluido','arquivado'].indexOf(p.status) === -1) {
            var days = Math.floor((now - new Date(p.updated_at)) / 86400000);
            strategic.push({type: 'Processo', title: p.title, status: labels[p.status] || p.status, priority: labels[p.priority] || p.priority, days: days});
        }
    });
    projetos.forEach(function(p) {
        if ((p.is_strategic || p.priority === 'alta' || p.priority === 'critica') && p.status !== 'concluido') {
            var days = Math.floor((now - new Date(p.updated_at)) / 86400000);
            strategic.push({type: 'Projeto', title: p.name, status: labels[p.status] || p.status, priority: labels[p.priority] || p.priority, days: days, progress: p.progress || 0});
        }
    });
    
    // Gerar PDF
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('Resumo Executivo - Itens Estrat√©gicos', 14, 20);
    doc.setFontSize(10);
    doc.text('Gabinete Dep. Rog√©rio Morro da Cruz | ' + dataHora, 14, 28);
    
    doc.setFontSize(12);
    doc.text('Vis√£o Geral:', 14, 42);
    doc.setFontSize(10);
    var emDia = strategic.filter(function(s) { return s.days <= 3; }).length;
    var atencao = strategic.filter(function(s) { return s.days > 3 && s.days <= 7; }).length;
    var criticos = strategic.filter(function(s) { return s.days > 7; }).length;
    doc.text('Em dia (at√© 3 dias): ' + emDia, 14, 50);
    doc.text('Aten√ß√£o (4-7 dias): ' + atencao, 14, 56);
    doc.text('Cr√≠ticos (+7 dias): ' + criticos, 14, 62);
    doc.text('Total estrat√©gicos: ' + strategic.length, 14, 68);
    
    if (strategic.length) {
        var prioOrder = {Cr√≠tica: 0, Alta: 1, M√©dia: 2, Baixa: 3};
        strategic.sort(function(a, b) { return (prioOrder[a.priority] || 2) - (prioOrder[b.priority] || 2) || b.days - a.days; });
        
        var tableData = strategic.map(function(s) {
            var situacao = s.days > 7 ? '‚ö†Ô∏è CR√çTICO' : (s.days > 3 ? '‚è∞ Aten√ß√£o' : '‚úÖ OK');
            return [s.type, decode(s.title).substring(0, 35), s.priority, s.status, s.days + 'd', situacao];
        });
        
        doc.autoTable({
            head: [['Tipo', 'T√≠tulo', 'Prioridade', 'Status', 'Dias', 'Situa√ß√£o']],
            body: tableData,
            startY: 78,
            styles: {fontSize: 8},
            headStyles: {fillColor: [22, 163, 74]}
        });
    }
    
    doc.save('resumo-executivo-' + now.toISOString().split('T')[0] + '.pdf');
}

function updateCharts() {
    // Propostas por Status
    var propStatus = {};
    propostas.forEach(function(p) { propStatus[p.status] = (propStatus[p.status] || 0) + 1; });
    if (charts.prop) charts.prop.destroy();
    var c1 = document.getElementById('chart-propostas');
    if (c1) {
        charts.prop = new Chart(c1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(propStatus).map(function(k) { return labels[k] || k; }),
                datasets: [{data: Object.values(propStatus), backgroundColor: ['#3b82f6','#f59e0b','#ec4899','#22c55e','#6b7280','#10b981','#ef4444']}]
            },
            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'right'}}}
        });
    }
    
    // Processos por Tipo
    var procType = {};
    processos.forEach(function(p) { procType[p.type] = (procType[p.type] || 0) + 1; });
    if (charts.proc) charts.proc.destroy();
    var c2 = document.getElementById('chart-processos');
    if (c2) {
        charts.proc = new Chart(c2, {
            type: 'bar',
            data: {
                labels: Object.keys(procType).map(function(k) { return labels[k] || k; }),
                datasets: [{data: Object.values(procType), backgroundColor: ['#6366f1','#22c55e','#ec4899','#f59e0b','#3b82f6']}]
            },
            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}, scales: {y: {beginAtZero: true}}}
        });
    }
    
    // Projetos por Fase
    var projStatus = {};
    projetos.forEach(function(p) { projStatus[p.status] = (projStatus[p.status] || 0) + 1; });
    if (charts.proj) charts.proj.destroy();
    var c3 = document.getElementById('chart-projetos');
    if (c3) {
        charts.proj = new Chart(c3, {
            type: 'polarArea',
            data: {
                labels: Object.keys(projStatus).map(function(k) { return labels[k] || k; }),
                datasets: [{data: Object.values(projStatus), backgroundColor: ['#8b5cf6','#6366f1','#3b82f6','#f59e0b','#22c55e','#6b7280']}]
            },
            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'right'}}}
        });
    }
    
    // Prioridades
    var prio = {baixa: 0, media: 0, alta: 0, critica: 0};
    propostas.concat(processos).concat(projetos).forEach(function(p) {
        if (p.priority) prio[p.priority]++;
    });
    if (charts.prio) charts.prio.destroy();
    var c4 = document.getElementById('chart-prioridades');
    if (c4) {
        charts.prio = new Chart(c4, {
            type: 'pie',
            data: {
                labels: ['Baixa', 'M√©dia', 'Alta', 'Cr√≠tica'],
                datasets: [{data: [prio.baixa, prio.media, prio.alta, prio.critica], backgroundColor: ['#6366f1','#f59e0b','#ef4444','#7f1d1d']}]
            },
            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'right'}}}
        });
    }
}
</script>

<script>
// ========== MODALS ==========
function openPropostaModal(id) {
    var p = id ? propostas.find(function(x) { return x.id === id; }) || {} : {};
    document.getElementById('modal-title').textContent = id ? 'Editar Proposta' : 'Nova Proposta';
    document.getElementById('modal-body').innerHTML = 
        '<div class="space-y-3">' +
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">' +
        '<div class="md:col-span-2"><label class="input-label">Nome do Projeto *</label><input type="text" id="f-project_name" class="input" value="' + (decode(p.project_name) || '') + '"></div>' +
        '<div><label class="input-label">Nome da OSC</label><input type="text" id="f-osc_name" class="input" value="' + (decode(p.osc_name) || '') + '"></div>' +
        '<div><label class="input-label">CNPJ</label><input type="text" id="f-osc_cnpj" class="input" value="' + (p.osc_cnpj || '') + '"></div>' +
        '<div><label class="input-label">Email</label><input type="email" id="f-contact_email" class="input" value="' + (p.contact_email || '') + '"></div>' +
        '<div><label class="input-label">Telefone</label><input type="text" id="f-contact_phone" class="input" value="' + (p.contact_phone || '') + '"></div>' +
        '<div><label class="input-label">Secretaria</label><input type="text" id="f-secretariat" class="input" value="' + (decode(p.secretariat) || '') + '"></div>' +
        '<div><label class="input-label">Valor (R$)</label><input type="text" id="f-requested_value" class="input" value="' + (p.requested_value || '') + '"></div>' +
        '<div class="md:col-span-2"><label class="input-label">Objetivo</label><textarea id="f-objective" rows="2" class="input">' + (decode(p.objective) || '') + '</textarea></div>' +
        '<div class="md:col-span-2"><label class="input-label">Descri√ß√£o</label><textarea id="f-description" rows="2" class="input">' + (decode(p.description) || '') + '</textarea></div>' +
        '</div><hr>' +
        '<div class="grid grid-cols-3 gap-3">' +
        '<div><label class="input-label">Status</label><select id="f-status" class="input">' +
        '<option value="recebida"' + (p.status === 'recebida' ? ' selected' : '') + '>Recebida</option>' +
        '<option value="em_analise"' + (p.status === 'em_analise' ? ' selected' : '') + '>Em an√°lise</option>' +
        '<option value="diligencia"' + (p.status === 'diligencia' ? ' selected' : '') + '>Dilig√™ncia</option>' +
        '<option value="priorizada"' + (p.status === 'priorizada' ? ' selected' : '') + '>Priorizada</option>' +
        '<option value="deferida"' + (p.status === 'deferida' ? ' selected' : '') + '>Deferida</option>' +
        '<option value="indeferida"' + (p.status === 'indeferida' ? ' selected' : '') + '>Indeferida</option>' +
        '<option value="encerrada"' + (p.status === 'encerrada' ? ' selected' : '') + '>Encerrada</option></select></div>' +
        '<div><label class="input-label">Prioridade</label><select id="f-priority" class="input">' +
        '<option value="baixa"' + (p.priority === 'baixa' ? ' selected' : '') + '>Baixa</option>' +
        '<option value="media"' + (p.priority === 'media' || !p.priority ? ' selected' : '') + '>M√©dia</option>' +
        '<option value="alta"' + (p.priority === 'alta' ? ' selected' : '') + '>Alta</option>' +
        '<option value="critica"' + (p.priority === 'critica' ? ' selected' : '') + '>Cr√≠tica</option></select></div>' +
        '<div><label class="input-label">Data</label><input type="date" id="f-submitted_at" class="input" value="' + (p.submitted_at ? p.submitted_at.split('T')[0] : '') + '"></div>' +
        '</div>' +
        '<div class="flex items-center gap-2"><input type="checkbox" id="f-is_strategic"' + (p.is_strategic ? ' checked' : '') + '><label for="f-is_strategic" class="text-sm">Estrat√©gico ‚≠ê</label></div>' +
        '<div><label class="input-label">Observa√ß√µes</label><textarea id="f-notes" rows="2" class="input">' + (p.notes || '') + '</textarea></div>' +
        '<div class="flex gap-2 pt-2">' +
        '<button onclick="submitProposta(' + (id ? "'" + id + "'" : 'null') + ')" class="btn btn-primary flex-1">Salvar</button>' +
        (id ? '<button onclick="deleteItem(\'propostas\',\'' + id + '\')" class="btn btn-danger">Excluir</button>' : '') +
        '<button onclick="closeModal()" class="btn btn-secondary">Cancelar</button></div></div>';
    openModal();
}

function submitProposta(id) {
    var data = {
        project_name: document.getElementById('f-project_name').value,
        osc_name: document.getElementById('f-osc_name').value,
        osc_cnpj: document.getElementById('f-osc_cnpj').value,
        contact_email: document.getElementById('f-contact_email').value,
        contact_phone: document.getElementById('f-contact_phone').value,
        secretariat: document.getElementById('f-secretariat').value,
        requested_value: document.getElementById('f-requested_value').value,
        objective: document.getElementById('f-objective').value,
        description: document.getElementById('f-description').value,
        status: document.getElementById('f-status').value,
        priority: document.getElementById('f-priority').value,
        submitted_at: document.getElementById('f-submitted_at').value || new Date().toISOString(),
        is_strategic: document.getElementById('f-is_strategic').checked,
        notes: document.getElementById('f-notes').value
    };
    if (!data.project_name) { alert('Nome do projeto obrigat√≥rio'); return; }
    saveProposta(data, id);
}

function openProcessoModal(id) {
    var p = id ? processos.find(function(x) { return x.id === id; }) || {} : {};
    document.getElementById('modal-title').textContent = id ? 'Editar Processo' : 'Novo Processo';
    document.getElementById('modal-body').innerHTML = 
        '<div class="space-y-3">' +
        '<div><label class="input-label">T√≠tulo *</label><input type="text" id="f-title" class="input" value="' + (decode(p.title) || '') + '"></div>' +
        '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">' +
        '<div><label class="input-label">Tipo</label><select id="f-type" class="input">' +
        '<option value="administrativo"' + (p.type === 'administrativo' ? ' selected' : '') + '>Administrativo</option>' +
        '<option value="legislativo"' + (p.type === 'legislativo' ? ' selected' : '') + '>Legislativo</option>' +
        '<option value="politico_institucional"' + (p.type === 'politico_institucional' ? ' selected' : '') + '>Pol√≠tico</option>' +
        '<option value="judicial"' + (p.type === 'judicial' ? ' selected' : '') + '>Judicial</option>' +
        '<option value="orcamentario"' + (p.type === 'orcamentario' ? ' selected' : '') + '>Or√ßament√°rio</option></select></div>' +
        '<div><label class="input-label">Status</label><select id="f-status" class="input">' +
        '<option value="iniciado"' + (p.status === 'iniciado' ? ' selected' : '') + '>Iniciado</option>' +
        '<option value="em_andamento"' + (p.status === 'em_andamento' || !p.status ? ' selected' : '') + '>Em andamento</option>' +
        '<option value="aguardando_terceiros"' + (p.status === 'aguardando_terceiros' ? ' selected' : '') + '>Aguardando</option>' +
        '<option value="travado"' + (p.status === 'travado' ? ' selected' : '') + '>Travado</option>' +
        '<option value="concluido"' + (p.status === 'concluido' ? ' selected' : '') + '>Conclu√≠do</option>' +
        '<option value="arquivado"' + (p.status === 'arquivado' ? ' selected' : '') + '>Arquivado</option></select></div>' +
        '<div><label class="input-label">Prioridade</label><select id="f-priority" class="input">' +
        '<option value="baixa"' + (p.priority === 'baixa' ? ' selected' : '') + '>Baixa</option>' +
        '<option value="media"' + (p.priority === 'media' || !p.priority ? ' selected' : '') + '>M√©dia</option>' +
        '<option value="alta"' + (p.priority === 'alta' ? ' selected' : '') + '>Alta</option>' +
        '<option value="critica"' + (p.priority === 'critica' ? ' selected' : '') + '>Cr√≠tica</option></select></div>' +
        '<div><label class="input-label">N¬∫ SEI</label><input type="text" id="f-sei" class="input" value="' + (p.sei || '') + '"></div>' +
        '<div><label class="input-label">Respons√°vel</label><input type="text" id="f-responsible" class="input" value="' + (decode(p.responsible) || '') + '"></div>' +
        '<div><label class="input-label">√ìrg√£o</label><input type="text" id="f-department" class="input" value="' + (decode(p.department) || '') + '"></div>' +
        '<div><label class="input-label">Abertura</label><input type="date" id="f-opened_at" class="input" value="' + (p.opened_at ? p.opened_at.split('T')[0] : '') + '"></div>' +
        '<div><label class="input-label">Prazo</label><input type="date" id="f-deadline" class="input" value="' + (p.deadline ? p.deadline.split('T')[0] : '') + '"></div></div>' +
        '<div><label class="input-label">Descri√ß√£o</label><textarea id="f-description" rows="2" class="input">' + (decode(p.description) || '') + '</textarea></div>' +
        '<div><label class="input-label">Pr√≥ximos Passos</label><textarea id="f-next_steps" rows="2" class="input">' + (decode(p.next_steps) || '') + '</textarea></div>' +
        '<div class="flex items-center gap-2"><input type="checkbox" id="f-is_strategic"' + (p.is_strategic ? ' checked' : '') + '><label for="f-is_strategic" class="text-sm">Estrat√©gico ‚≠ê</label></div>' +
        '<div><label class="input-label">Observa√ß√µes</label><textarea id="f-notes" rows="2" class="input">' + (p.notes || '') + '</textarea></div>' +
        '<div class="flex gap-2 pt-2">' +
        '<button onclick="submitProcesso(' + (id ? "'" + id + "'" : 'null') + ')" class="btn btn-primary flex-1">Salvar</button>' +
        (id ? '<button onclick="deleteItem(\'processos\',\'' + id + '\')" class="btn btn-danger">Excluir</button>' : '') +
        '<button onclick="closeModal()" class="btn btn-secondary">Cancelar</button></div></div>';
    openModal();
}

function submitProcesso(id) {
    var data = {
        title: document.getElementById('f-title').value,
        type: document.getElementById('f-type').value,
        status: document.getElementById('f-status').value,
        priority: document.getElementById('f-priority').value,
        sei: document.getElementById('f-sei').value,
        responsible: document.getElementById('f-responsible').value,
        department: document.getElementById('f-department').value,
        opened_at: document.getElementById('f-opened_at').value,
        deadline: document.getElementById('f-deadline').value,
        description: document.getElementById('f-description').value,
        next_steps: document.getElementById('f-next_steps').value,
        is_strategic: document.getElementById('f-is_strategic').checked,
        notes: document.getElementById('f-notes').value
    };
    if (!data.title) { alert('T√≠tulo obrigat√≥rio'); return; }
    saveProcesso(data, id);
}

function openProjetoModal(id) {
    var p = id ? projetos.find(function(x) { return x.id === id; }) || {} : {};
    var cfg = JSON.parse(localStorage.getItem('appConfig') || '{}');
    var axes = (cfg.axes || 'Prote√ß√£o Social\nMeio Ambiente\nDesenvolvimento Urbano\nEduca√ß√£o').split('\n').filter(Boolean);
    
    document.getElementById('modal-title').textContent = id ? 'Editar Projeto' : 'Novo Projeto';
    document.getElementById('modal-body').innerHTML = 
        '<div class="space-y-3">' +
        '<div><label class="input-label">Nome *</label><input type="text" id="f-name" class="input" value="' + (decode(p.name) || '') + '"></div>' +
        '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">' +
        '<div><label class="input-label">Eixo</label><select id="f-axis" class="input"><option value="">Selecione</option>' +
        axes.map(function(a) { return '<option value="' + a + '"' + (p.axis === a ? ' selected' : '') + '>' + a + '</option>'; }).join('') + '</select></div>' +
        '<div><label class="input-label">Fase</label><select id="f-status" class="input">' +
        '<option value="concepcao"' + (p.status === 'concepcao' || !p.status ? ' selected' : '') + '>Concep√ß√£o</option>' +
        '<option value="planejamento"' + (p.status === 'planejamento' ? ' selected' : '') + '>Planejamento</option>' +
        '<option value="articulacao"' + (p.status === 'articulacao' ? ' selected' : '') + '>Articula√ß√£o</option>' +
        '<option value="execucao"' + (p.status === 'execucao' ? ' selected' : '') + '>Execu√ß√£o</option>' +
        '<option value="monitoramento"' + (p.status === 'monitoramento' ? ' selected' : '') + '>Monitoramento</option>' +
        '<option value="concluido"' + (p.status === 'concluido' ? ' selected' : '') + '>Conclu√≠do</option></select></div>' +
        '<div><label class="input-label">Prioridade</label><select id="f-priority" class="input">' +
        '<option value="baixa"' + (p.priority === 'baixa' ? ' selected' : '') + '>Baixa</option>' +
        '<option value="media"' + (p.priority === 'media' || !p.priority ? ' selected' : '') + '>M√©dia</option>' +
        '<option value="alta"' + (p.priority === 'alta' ? ' selected' : '') + '>Alta</option>' +
        '<option value="critica"' + (p.priority === 'critica' ? ' selected' : '') + '>Cr√≠tica</option></select></div>' +
        '<div><label class="input-label">Progresso %</label><input type="number" id="f-progress" class="input" value="' + (p.progress || 0) + '" min="0" max="100"></div>' +
        '<div><label class="input-label">Coordenador</label><input type="text" id="f-coordinator" class="input" value="' + (decode(p.coordinator) || '') + '"></div>' +
        '<div><label class="input-label">Equipe</label><input type="text" id="f-team" class="input" value="' + (decode(p.team) || '') + '"></div>' +
        '<div><label class="input-label">In√≠cio</label><input type="date" id="f-start_date" class="input" value="' + (p.start_date ? p.start_date.split('T')[0] : '') + '"></div>' +
        '<div><label class="input-label">T√©rmino</label><input type="date" id="f-end_date" class="input" value="' + (p.end_date ? p.end_date.split('T')[0] : '') + '"></div>' +
        '<div><label class="input-label">Or√ßamento</label><input type="text" id="f-budget" class="input" value="' + (p.budget || '') + '"></div></div>' +
        '<div><label class="input-label">Objetivo Pol√≠tico</label><textarea id="f-political_objective" rows="2" class="input">' + (decode(p.political_objective) || '') + '</textarea></div>' +
        '<div><label class="input-label">Descri√ß√£o</label><textarea id="f-description" rows="2" class="input">' + (decode(p.description) || '') + '</textarea></div>' +
        '<div><label class="input-label">Entregas</label><textarea id="f-deliverables" rows="2" class="input">' + (decode(p.deliverables) || '') + '</textarea></div>' +
        '<div><label class="input-label">Parceiros</label><textarea id="f-partners" rows="2" class="input">' + (decode(p.partners) || '') + '</textarea></div>' +
        '<div class="flex items-center gap-2"><input type="checkbox" id="f-is_strategic"' + (p.is_strategic ? ' checked' : '') + '><label for="f-is_strategic" class="text-sm">Estrat√©gico ‚≠ê</label></div>' +
        '<div><label class="input-label">Observa√ß√µes</label><textarea id="f-notes" rows="2" class="input">' + (p.notes || '') + '</textarea></div>' +
        '<div class="flex gap-2 pt-2">' +
        '<button onclick="submitProjeto(' + (id ? "'" + id + "'" : 'null') + ')" class="btn btn-primary flex-1">Salvar</button>' +
        (id ? '<button onclick="deleteItem(\'projetos\',\'' + id + '\')" class="btn btn-danger">Excluir</button>' : '') +
        '<button onclick="closeModal()" class="btn btn-secondary">Cancelar</button></div></div>';
    openModal();
}

function submitProjeto(id) {
    var data = {
        name: document.getElementById('f-name').value,
        axis: document.getElementById('f-axis').value,
        status: document.getElementById('f-status').value,
        priority: document.getElementById('f-priority').value,
        progress: parseInt(document.getElementById('f-progress').value) || 0,
        coordinator: document.getElementById('f-coordinator').value,
        team: document.getElementById('f-team').value,
        start_date: document.getElementById('f-start_date').value,
        end_date: document.getElementById('f-end_date').value,
        budget: document.getElementById('f-budget').value,
        political_objective: document.getElementById('f-political_objective').value,
        description: document.getElementById('f-description').value,
        deliverables: document.getElementById('f-deliverables').value,
        partners: document.getElementById('f-partners').value,
        is_strategic: document.getElementById('f-is_strategic').checked,
        notes: document.getElementById('f-notes').value
    };
    if (!data.name) { alert('Nome obrigat√≥rio'); return; }
    saveProjeto(data, id);
}
</script>

<script>
// ========== IMPORT/EXPORT ==========
function handleFileUpload(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var data = new Uint8Array(ev.target.result);
            var wb = XLSX.read(data, {type: 'array', codepage: 65001, cellDates: true, dateNF: 'yyyy-mm-dd'});
            var sheet = wb.Sheets[wb.SheetNames[0]];
            var json = XLSX.utils.sheet_to_json(sheet, {defval: '', raw: false});
            if (!json.length) { alert('Planilha vazia'); return; }
            importData = json.map(function(r) { return parseRow(r); });
            showPreview();
        } catch(err) { alert('Erro: ' + err.message); }
    };
    reader.readAsArrayBuffer(file);
}

function importFromPaste() {
    var text = document.getElementById('import-paste').value.trim();
    if (!text) { alert('Cole os dados'); return; }
    var lines = text.split('\n').map(function(l) { return l.split('\t'); });
    if (lines.length < 2) { alert('Dados insuficientes'); return; }
    var headers = lines[0];
    importData = lines.slice(1).filter(function(r) { return r.length > 1; }).map(function(row) {
        var obj = {};
        headers.forEach(function(h, i) { obj[h.trim()] = row[i] || ''; });
        return parseRow(obj);
    });
    showPreview();
}

function parseRow(row) {
    function find(keys) {
        for (var i = 0; i < keys.length; i++) {
            for (var key in row) {
                if (key.toLowerCase().indexOf(keys[i].toLowerCase()) !== -1 && row[key]) {
                    return String(row[key]);
                }
            }
        }
        return '';
    }
    
    // Fun√ß√£o para converter data do Excel (n√∫mero serial) para ISO string
    function parseDate(val) {
        if (!val) return new Date().toISOString();
        // Se j√° for uma string de data v√°lida
        if (typeof val === 'string') {
            var d = new Date(val);
            if (!isNaN(d.getTime())) return d.toISOString();
            // Tenta formato DD/MM/YYYY
            var parts = val.split('/');
            if (parts.length === 3) {
                d = new Date(parts[2], parts[1] - 1, parts[0]);
                if (!isNaN(d.getTime())) return d.toISOString();
            }
        }
        // Se for n√∫mero (serial do Excel)
        if (typeof val === 'number') {
            // Excel conta dias desde 1/1/1900 (com bug do ano 1900)
            var excelEpoch = new Date(1899, 11, 30);
            var d = new Date(excelEpoch.getTime() + val * 86400000);
            if (!isNaN(d.getTime())) return d.toISOString();
        }
        return new Date().toISOString();
    }
    
    var dateVal = find(['carimbo', 'data', 'timestamp']);
    
    return {
        project_name: find(['nome do projeto', 'projeto', 'project']),
        osc_name: find(['organiza√ß√£o da sociedade civil', 'osc', 'organiza√ß√£o', 'organizacao', 'entidade']),
        osc_cnpj: find(['cnpj']),
        secretariat: find(['secretaria']),
        requested_value: find(['valor']),
        objective: find(['objetivo sucinto', 'objetivo']),
        description: find(['descri√ß√£o do projeto', 'descri√ß√£o', 'descricao']),
        contact_name: find(['respons√°vel pela osc', 'responsavel pela osc']),
        project_responsible: find(['respons√°vel pelo projeto', 'responsavel pelo projeto']),
        contact_email: find(['email', 'e-mail']),
        contact_phone: find(['telefone', 'phone', 'fone']),
        submitted_at: parseDate(dateVal)
    };
}

function showPreview() {
    var prev = document.getElementById('import-preview');
    var cont = document.getElementById('preview-content');
    cont.innerHTML = '<table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-2">Projeto</th><th class="p-2">OSC</th><th class="p-2">Valor</th><th class="p-2">Data</th></tr></thead><tbody>' +
        importData.slice(0, 8).map(function(r) {
            return '<tr class="border-t"><td class="p-2">' + (decode(r.project_name) || '-') + '</td><td class="p-2">' + (decode(r.osc_name) || '-') + '</td><td class="p-2">' + (r.requested_value || '-') + '</td><td class="p-2">' + fmtDate(r.submitted_at) + '</td></tr>';
        }).join('') +
        (importData.length > 8 ? '<tr><td colspan="4" class="p-2 text-gray-500">... +' + (importData.length - 8) + ' registros</td></tr>' : '') +
        '</tbody></table>';
    prev.classList.remove('hidden');
    document.getElementById('import-status').innerHTML = '<span class="text-blue-600">üìã ' + importData.length + ' registros prontos</span>';
}

function confirmImport() {
    if (!importData.length) return;
    document.getElementById('import-status').innerHTML = '<span class="text-gray-600">Importando...</span>';
    batchImport(importData).then(function() {
        document.getElementById('import-status').innerHTML = '<span class="text-green-600">‚úÖ ' + importData.length + ' propostas importadas!</span>';
        importData = [];
        document.getElementById('import-preview').classList.add('hidden');
        document.getElementById('import-paste').value = '';
        document.getElementById('import-file').value = '';
    }).catch(function(err) {
        document.getElementById('import-status').innerHTML = '<span class="text-red-600">‚ùå Erro: ' + err.message + '</span>';
    });
}

function cancelImport() {
    importData = [];
    document.getElementById('import-preview').classList.add('hidden');
    document.getElementById('import-status').textContent = '';
}

function exportCSV(type) {
    var data, filename, headers;
    if (type === 'propostas') {
        headers = ['Projeto', 'OSC', 'CNPJ', 'Secretaria', 'Valor', 'Status', 'Prioridade', 'Data'];
        data = propostas.map(function(p) { return [p.project_name, p.osc_name, p.osc_cnpj, p.secretariat, p.requested_value, p.status, p.priority, fmtDate(p.submitted_at)]; });
        filename = 'propostas.csv';
    } else if (type === 'processos') {
        headers = ['T√≠tulo', 'Tipo', 'Status', 'Prioridade', 'SEI', 'Respons√°vel', 'Prazo'];
        data = processos.map(function(p) { return [p.title, p.type, p.status, p.priority, p.sei, p.responsible, fmtDate(p.deadline)]; });
        filename = 'processos.csv';
    } else {
        headers = ['Nome', 'Eixo', 'Fase', 'Prioridade', 'Progresso', 'Coordenador', 'In√≠cio', 'T√©rmino'];
        data = projetos.map(function(p) { return [p.name, p.axis, p.status, p.priority, p.progress + '%', p.coordinator, fmtDate(p.start_date), fmtDate(p.end_date)]; });
        filename = 'projetos.csv';
    }
    var BOM = '\uFEFF';
    var csv = BOM + [headers.join(';')].concat(data.map(function(row) {
        return row.map(function(c) { return '"' + (c || '').toString().replace(/"/g, '""') + '"'; }).join(';');
    })).join('\n');
    var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

function exportPDF(type) {
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF();
    doc.setFontSize(16);
    doc.text(type.charAt(0).toUpperCase() + type.slice(1), 14, 20);
    doc.setFontSize(10);
    doc.text('Gerado: ' + new Date().toLocaleString('pt-BR'), 14, 28);
    var headers, data;
    if (type === 'propostas') {
        headers = [['Projeto', 'OSC', 'Valor', 'Status']];
        data = propostas.map(function(p) { return [decode(p.project_name).substring(0, 30), decode(p.osc_name).substring(0, 20), p.requested_value || '-', p.status]; });
    } else if (type === 'processos') {
        headers = [['T√≠tulo', 'Tipo', 'Status', 'Prazo']];
        data = processos.map(function(p) { return [decode(p.title).substring(0, 35), p.type, p.status, fmtDate(p.deadline)]; });
    } else {
        headers = [['Nome', 'Eixo', 'Fase', '%']];
        data = projetos.map(function(p) { return [decode(p.name).substring(0, 35), decode(p.axis) || '-', p.status, (p.progress || 0) + '%']; });
    }
    doc.autoTable({head: headers, body: data, startY: 35, styles: {fontSize: 8}});
    doc.save(type + '.pdf');
}

function exportDashboardPDF() {
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF();
    doc.setFontSize(18);
    doc.text('Relat√≥rio Dashboard', 14, 20);
    doc.setFontSize(10);
    doc.text('Gerado: ' + new Date().toLocaleString('pt-BR'), 14, 28);
    doc.setFontSize(12);
    doc.text('Resumo', 14, 45);
    doc.setFontSize(11);
    doc.text('Propostas: ' + propostas.length, 14, 55);
    doc.text('Processos: ' + processos.length, 14, 63);
    doc.text('Projetos: ' + projetos.length, 14, 71);
    doc.save('dashboard.pdf');
}

function exportAllData() {
    var data = {
        propostas: propostas,
        processos: processos,
        projetos: projetos,
        config: JSON.parse(localStorage.getItem('appConfig') || '{}'),
        exportedAt: new Date().toISOString()
    };
    var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'backup-' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
}

function importBackup(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var data = JSON.parse(ev.target.result);
            if (data.config) {
                localStorage.setItem('appConfig', JSON.stringify(data.config));
                loadConfig();
            }
            alert('Config restaurada!');
        } catch(err) { alert('Erro: ' + err.message); }
    };
    reader.readAsText(file);
}
</script>

<script>
// ========== CONFIG ==========
function loadConfig() {
    var cfg = JSON.parse(localStorage.getItem('appConfig') || '{}');
    document.getElementById('cfg-color1').value = cfg.primaryColor || '#16a34a';
    document.getElementById('cfg-color1-t').value = cfg.primaryColor || '#16a34a';
    document.getElementById('cfg-color2').value = cfg.secondaryColor || '#f97316';
    document.getElementById('cfg-color2-t').value = cfg.secondaryColor || '#f97316';
    document.getElementById('cfg-axes').value = cfg.axes || 'Prote√ß√£o Social\nMeio Ambiente\nDesenvolvimento Urbano\nEduca√ß√£o e Cultura';
    if (cfg.primaryColor) document.documentElement.style.setProperty('--primary', cfg.primaryColor);
    if (cfg.secondaryColor) document.documentElement.style.setProperty('--secondary', cfg.secondaryColor);
    
    document.getElementById('cfg-color1').addEventListener('input', function(e) {
        document.getElementById('cfg-color1-t').value = e.target.value;
    });
    document.getElementById('cfg-color1-t').addEventListener('input', function(e) {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) document.getElementById('cfg-color1').value = e.target.value;
    });
    document.getElementById('cfg-color2').addEventListener('input', function(e) {
        document.getElementById('cfg-color2-t').value = e.target.value;
    });
    document.getElementById('cfg-color2-t').addEventListener('input', function(e) {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) document.getElementById('cfg-color2').value = e.target.value;
    });
}

function saveConfig() {
    var cfg = {
        primaryColor: document.getElementById('cfg-color1').value,
        secondaryColor: document.getElementById('cfg-color2').value,
        axes: document.getElementById('cfg-axes').value
    };
    localStorage.setItem('appConfig', JSON.stringify(cfg));
    document.documentElement.style.setProperty('--primary', cfg.primaryColor);
    document.documentElement.style.setProperty('--secondary', cfg.secondaryColor);
    alert('Salvo!');
}

function resetConfig() {
    if (confirm('Restaurar padr√£o?')) {
        localStorage.removeItem('appConfig');
        location.reload();
    }
}
</script>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyD9KXFMYUVg3DKbvVrbZfQp6iO3JS4o3P8",
    authDomain: "gabinete-painel.firebaseapp.com",
    projectId: "gabinete-painel",
    storageBucket: "gabinete-painel.firebasestorage.app",
    messagingSenderId: "132085487240",
    appId: "1:132085487240:web:a291e9688c39fd86bdf13d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
db = getFirestore(app);

// Auth
onAuthStateChanged(auth, function(u) {
    if (u) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-email').textContent = u.email;
        loadData();
        loadConfig();
        showTab('dashboard');
    } else {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-screen').classList.add('hidden');
    }
});

document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const pw = document.getElementById('login-password').value;
    const err = document.getElementById('login-error');
    const ld = document.getElementById('login-loader');
    err.classList.add('hidden');
    ld.classList.remove('hidden');
    try {
        await signInWithEmailAndPassword(auth, email, pw);
    } catch(error) {
        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
            try {
                await createUserWithEmailAndPassword(auth, email, pw);
            } catch(e2) {
                err.textContent = 'Erro: ' + e2.message;
                err.classList.remove('hidden');
            }
        } else {
            err.textContent = 'Erro: ' + error.message;
            err.classList.remove('hidden');
        }
    }
    ld.classList.add('hidden');
});

window.logout = function() { signOut(auth); };

function loadData() {
    onSnapshot(query(collection(db, 'propostas'), orderBy('created_at', 'desc')), function(s) {
        propostas = s.docs.map(function(d) { return Object.assign({id: d.id}, d.data()); });
        renderPropostas();
        updateDashboard();
    });
    onSnapshot(query(collection(db, 'processos'), orderBy('created_at', 'desc')), function(s) {
        processos = s.docs.map(function(d) { return Object.assign({id: d.id}, d.data()); });
        renderProcessos();
        updateDashboard();
    });
    onSnapshot(query(collection(db, 'projetos'), orderBy('created_at', 'desc')), function(s) {
        projetos = s.docs.map(function(d) { return Object.assign({id: d.id}, d.data()); });
        renderProjetos();
        updateDashboard();
        updateAxisFilter();
    });
}

window.saveProposta = async function(data, id) {
    data.updated_at = new Date().toISOString();
    if (id) {
        await updateDoc(doc(db, 'propostas', id), data);
    } else {
        data.created_at = new Date().toISOString();
        data.status = data.status || 'recebida';
        data.priority = data.priority || 'media';
        await addDoc(collection(db, 'propostas'), data);
    }
    closeModal();
};

window.saveProcesso = async function(data, id) {
    data.updated_at = new Date().toISOString();
    if (id) {
        await updateDoc(doc(db, 'processos', id), data);
    } else {
        data.created_at = new Date().toISOString();
        await addDoc(collection(db, 'processos'), data);
    }
    closeModal();
};

window.saveProjeto = async function(data, id) {
    data.updated_at = new Date().toISOString();
    if (id) {
        await updateDoc(doc(db, 'projetos', id), data);
    } else {
        data.created_at = new Date().toISOString();
        await addDoc(collection(db, 'projetos'), data);
    }
    closeModal();
};

window.deleteItem = async function(col, id) {
    if (confirm('Excluir?')) {
        await deleteDoc(doc(db, col, id));
        closeModal();
    }
};

window.batchImport = async function(items) {
    const batch = writeBatch(db);
    const now = new Date().toISOString();
    items.forEach(function(item) {
        const ref = doc(collection(db, 'propostas'));
        batch.set(ref, Object.assign({}, item, {created_at: now, updated_at: now, status: 'recebida', priority: 'media', is_strategic: false}));
    });
    await batch.commit();
};
</script>

</body>
</html>
